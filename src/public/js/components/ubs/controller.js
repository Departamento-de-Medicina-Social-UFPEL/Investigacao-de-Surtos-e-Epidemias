// Generated by CoffeeScript 2.7.0
define(['./views/lista/LayoutView', './views/nova/LayoutView', './views/nova/UfsCollView', './views/nova/MunCollView', './views/nova/UbsCollView', './views/nova/InfoModalSelView', './collections/UbsColl', './models/UbsModel', 'backbone', 'marionette'], function(ListaUbsLayoutView, NovaUbsLayoutView, UfsCollView, MunCollView, UbsCollView, InfoModalView, UbsColl, UbsModel, Backbone, Marionette) {
  var selectMunView;
  selectMunView = new MunCollView({
    collection: new Backbone.Collection([
      {
        nome: 'Selecione o município',
        ibge: -123
      }
    ])
  });
  return {
    'listaUbs': function(callback) {
      // App.main.show new ListaUbsLayoutView
      Backbone.history.navigate('comp/ubs/nova', {
        trigger: true
      });
      if (callback) {
        return callback.apply(this);
      }
    },
    'novaUbs': function(callback) {
      console.log('novaUbs');
      App.main.show(new UfsCollView());
      if (callback) {
        return callback.apply(this);
      }
    },
    'selecionaEstado': function(uf, callback) {
      var current;
      current = App.main.currentView;
      if (!current) {
        this.novaUbs(function() {
          return this.selecionaEstado(uf, callback);
        });
        return;
      }
      // current.selUf.$el.find('select').val uf
      this.carregaMuns(uf, current);
      current.selMun.show(selectMunView);
      if (callback) {
        return callback.apply(this);
      }
    },
    'selecionaMunicipio': function(uf, ibgeCod, callback) {
      var current, estado;
      current = App.main.currentView;
      if (!current) {
        this.novaUbs(function() {
          return this.selecionaEstado(uf, function() {
            return this.selecionaMunicipio(uf, ibgeCod);
          });
        });
        return;
      }
      // current.selUf.$el.find('select').val uf
      if (selectMunView.collection.length < 2) {
        estado = _.findWhere(App.estados, {
          sigla: uf.toUpperCase()
        });
        selectMunView.collection.reset(first.cidade.concat(estado.cidades));
      }
      this.carregaUbs(uf, ibgeCod);
      current.selMun.show(selectMunView);
      current.selMun.$el.find('select').val(parseInt(ibgeCod));
      if (callback) {
        return callback.apply(this);
      }
    },
    'selecionaUbs': function(uf, ibgeCod, cnes, callback) {
      var current, ubs;
      console.log("'selecionaUbs': (uf, ibgeCod, cnes, callback) ->");
      current = App.main.currentView;
      if (!current) {
        this.novaUbs(function() {
          return this.selecionaEstado(uf, function() {
            return this.selecionaMunicipio(uf, ibgeCod, function() {
              return this.selecionaUbs(uf, ibgeCod, cnes);
            });
          });
        });
        return;
      }
      ubs = new UbsModel();
      ubs.url = `/ubs/${cnes}`;
      ubs.fetch({
        'success': function(dataModel) {
          var e, modal;
          modal = new InfoModalView({
            'model': dataModel
          });
          modal.render();
          e = modal.$el;
          e.appendTo('#mainStage');
          return e.modal();
        }
      });
      if (callback) {
        // e.find('.modal-backdrop').show()
        return callback.apply(this);
      }
    },
    // console.log uf, ibgeCod, cnes
    'carregaMuns': function(uf) {
      var estado, first;
      estado = _.findWhere(App.estados, {
        sigla: uf.toUpperCase()
      });
      first = [
        {
          nome: 'Selecione o município',
          ibge: -123
        }
      ];
      return selectMunView = new MunCollView({
        collection: new Backbone.Collection(first.concat(estado.cidades))
      });
    },
    'carregaUbs': function(uf, ibge) {
      var ubsColl;
      ubsColl = new UbsColl();
      ubsColl.url = `/ubs/busca/codibge/${ibge}`;
      return ubsColl.fetch({
        'success': function(collection) {
          var collV;
          collV = new UbsCollView({collection});
          App.main.currentView.selUbs.show(collV);
          collV.$el.find('.cidade').text(App.main.currentView.selMun.$el.find('option:selected').text());
          return collV.$el.find('.estado').text(uf);
        }
      });
    }
  };
});
