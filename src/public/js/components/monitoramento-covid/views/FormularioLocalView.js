// Generated by CoffeeScript 2.7.0
define(['../collections/Monitoramentos', '../models/Monitoramento', 'utils', 'uf_municipios'], function(Monitoramentos, Monitoramento, utils, uf) {
  var FormularioLocalView;
  FormularioLocalView = (function() {
    class FormularioLocalView extends Marionette.CompositeView {
      initialize() {
        var local, user;
        ({user, local} = App);
        if (!this.model) {
          return this.model = new Monitoramento();
        }
      }

      removeErro(e) {
        return $(e.target).parent().removeClass('has-error');
      }

      salvar() {
        var camposErros, dados, err, m, v;
        this.ui.btnSave.attr('disabled', true);
        dados = {
          "user": App.user.cpf,
          "local": this.ui.inputLocal.val(),
          "uf": this.ui.inputUf.val(),
          "municipio": this.ui.inputMunicipio.val(),
          "tipo": this.ui.inputTipo.filter(':checked').val()
        };
        err = false;
        camposErros = [];
        for (v in dados) {
          if (!dados[v]) {
            err = true;
            camposErros.push('#input' + v.slice(0, 1).toUpperCase() + v.slice(1));
          }
        }
        if (err) {
          camposErros.forEach(function(c) {
            return $(c).parent().addClass('has-error');
          });
          $(camposErros[0]).focus();
        }
        dados['ibge'] = this.ui.ibge.val();
        for (v in dados) {
          this.model.set(v, dados[v]);
        }
        if (!this.model.get('id')) {
          dados['id'] = this.model.cid;
          m = App.monitoramentos.create(dados);
        } else {
          m = App.monitoramentos.update(this.model);
        }
        this.ui.btnSave.attr('disabled', false);
        return App.appRouter.navigate('#comp/monitoramento-covid/local/' + m.id, {
          'trigger': true
        });
      }

      montaComboEstados() {
        var i, len, sigla, siglas;
        //console.log 'monta combos estados'
        siglas = staticData.estados.map(function(v) {
          return v.sigla;
        });
        this.$el.find('[name="inputUf"]').empty();
        this.$el.find('[name="inputUf"]').append("<option value='-1'>Selecione</option>");
        for (i = 0, len = siglas.length; i < len; i++) {
          sigla = siglas[i];
          this.$el.find('[name="inputUf"]').append("<option value='" + sigla + "'>" + sigla + "</option>");
        }
        if (this.user) {
          if (this.user.uf) {
            return this.$el.find('[name="inputUf"]').val(this.user.uf);
          }
        }
      }

      obtemMunicipios() {
        var cit, cits, estado, i, k, len, muniSel, opt, ref, uma;
        uf = this.$el.find('[name="inputUf"]').val();
        muniSel = this.$el.find('[name="inputMunicipio"]');
        muniSel.prop('disabled', 'disabled');
        cits = [];
        ref = staticData.estados;
        for (k = i = 0, len = ref.length; i < len; k = ++i) {
          estado = ref[k];
          if (estado.sigla === uf) {
            cits = estado.cidades;
          }
        }
        muniSel.empty();
        if (uf !== '-1') {
          muniSel.append($('<option value="-1">selecione...</option>'));
          for (uma in cits) {
            cit = cits[uma];
            opt = $('<option value="' + cit.nome + '" data-ibge="' + cit.ibge + '">' + cit.nome + '</option>');
            opt.appendTo(muniSel);
          }
          muniSel.removeAttr('disabled');
        } else {
          muniSel.append($('<option value="-1">&#8592; Escolha um estado</option>'));
          muniSel.attr('disabled', true);
        }
        if (this.user) {
          if (this.user.municipio) {
            return this.$el.find('[name="inputMunicipio"]').val(this.user.municipio);
          }
        }
      }

      muni_ibge() {
        var ibge;
        ibge = $('[name="inputMunicipio"]').children(':checked').data('ibge');
        return $('[name="ibge"]').val(ibge);
      }

      prettyNome(evt) {
        var str;
        this.hadFocus = $(evt.target);
        str = $(evt.target).val();
        str = utils.pretty.name(str);
        return $(evt.target).val(str);
      }

      preenche() {
        //console.log @model, 'model'
        if (!this.model.get('id')) {
          return;
        }
        this.ui.inputLocal.val(this.model.get('nome'));
        this.ui.inputUf.val(this.model.get('uf'));
        return this.ui.inputMunicipio.val(this.model.get('municipio'));
      }

      onRender() {
        this.montaComboEstados();
        //@obtemMunicipios()      
        return this.preenche();
      }

    };

    FormularioLocalView.prototype.className = 'container';

    FormularioLocalView.prototype.template = '#monitoramento-covid-formulario-local';

    FormularioLocalView.prototype.ui = {
      'btnClear': ".btn-clear",
      'btnSave': ".btn-save",
      "inputLocal": "#inputLocal",
      "inputUf": "#inputUf",
      "inputMunicipio": "#inputMunicipio",
      "ibge": "#inputIbge",
      "inputTipo": 'input:radio[name="optionRadiosTipoAmostragem"]'
    };

    FormularioLocalView.prototype.events = {
      'click .btn-clear': "limpar",
      'click .btn-save': "salvar",
      'change input': 'removeErro',
      'change [name="inputUf"]': 'obtemMunicipios',
      //'blur #inputLocal': 'prettyNome'
      'change select[name="inputMunicipio"]': 'muni_ibge',
      'blur select[name="inputMunicipio"]': 'muni_ibge'
    };

    return FormularioLocalView;

  }).call(this);
  return FormularioLocalView;
});
