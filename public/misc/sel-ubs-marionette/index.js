// Generated by CoffeeScript 1.9.0
(function() {
  var DemoAppFormLocal, EstadoSelectView, MunicipioSelectView, SelectItemView, UbsCollection, UbsFormLayout, UbsSelectView, dummy, rawUfs,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty;

  rawUfs = _.map(staticData.estados, function(item) {
    return _.partial(_.pick, item).apply(null, ['sigla', 'nome']);
  });

  rawUfs = rawUfs.map(function(i) {
    return {
      value: i.sigla,
      text: i.nome
    };
  });

  dummy = function(text) {
    return {
      value: '-1',
      text: text || 'Selecione...'
    };
  };

  UbsFormLayout = (function(_super) {
    __extends(UbsFormLayout, _super);

    function UbsFormLayout() {
      return UbsFormLayout.__super__.constructor.apply(this, arguments);
    }

    UbsFormLayout.prototype.tagName = 'form';

    UbsFormLayout.prototype.template = '#local-template';

    UbsFormLayout.prototype.onRender = function() {
      this.addRegions({
        'ufBox': '.ufBox',
        'muniBox': '.muniBox',
        'ubsBox': '.ubsBox'
      });
      this.ufBox.show(new EstadoSelectView({
        collection: new Backbone.Collection([dummy('UF')].concat(rawUfs))
      }));
      this.muniBox.show(new MunicipioSelectView({
        collection: new Backbone.Collection([dummy('Escolha um estado.')])
      }));
      return this.ubsBox.show(new UbsSelectView({
        collection: new UbsCollection([dummy('Escolha um estado e um município.')])
      }));
    };

    UbsFormLayout.prototype.childEvents = {
      'mostra:municipiosDeUf': function(child, uf) {
        var cidades, estado, muniColl, ubsColl;
        muniColl = this.muniBox.currentView.collection;
        ubsColl = this.ubsBox.currentView.collection;
        ubsColl.reset([dummy('Escolha um estado e um município.')]);
        if (uf === '-1') {
          return muniColl.reset([dummy('Escolha um estado.')]);
        }
        estado = _.findWhere(staticData.estados, {
          sigla: uf.toUpperCase()
        });
        cidades = estado.cidades.map(function(i) {
          return {
            value: i.ibge,
            text: i.nome
          };
        });
        return muniColl.reset([dummy()].concat(cidades));
      },
      'mostra:ubsDeMun': function(child, ibge) {
        var ubsColl;
        ubsColl = this.ubsBox.currentView.collection;
        if (ibge === '-1') {
          return ubsColl.reset([dummy('Escolha um estado e um município.')]);
        }
        ubsColl.reset([dummy('Carregando...')]);
        ubsColl.ibge = ibge;
        return ubsColl.fetch();
      }
    };

    return UbsFormLayout;

  })(Marionette.LayoutView);

  SelectItemView = (function(_super) {
    __extends(SelectItemView, _super);

    function SelectItemView() {
      return SelectItemView.__super__.constructor.apply(this, arguments);
    }

    SelectItemView.prototype.tagName = 'select';

    SelectItemView.prototype.className = 'form-control input-lg';

    SelectItemView.prototype.template = '#select-template';

    return SelectItemView;

  })(Marionette.ItemView);

  EstadoSelectView = (function(_super) {
    __extends(EstadoSelectView, _super);

    function EstadoSelectView() {
      return EstadoSelectView.__super__.constructor.apply(this, arguments);
    }

    EstadoSelectView.prototype.events = {
      'change': 'mostra'
    };

    EstadoSelectView.prototype.mostra = function() {
      return this.triggerMethod('mostra:municipiosDeUf', this.$el.val());
    };

    return EstadoSelectView;

  })(SelectItemView);

  MunicipioSelectView = (function(_super) {
    __extends(MunicipioSelectView, _super);

    function MunicipioSelectView() {
      return MunicipioSelectView.__super__.constructor.apply(this, arguments);
    }

    MunicipioSelectView.prototype.events = {
      'change': 'mostra'
    };

    MunicipioSelectView.prototype.initialize = function() {
      return this.listenTo(this.collection, 'reset', this.render);
    };

    MunicipioSelectView.prototype.mostra = function() {
      return this.triggerMethod('mostra:ubsDeMun', this.$el.val());
    };

    MunicipioSelectView.prototype.onBeforeRender = function() {
      return this.$el.empty().attr({
        disabled: 'disabled'
      });
    };

    MunicipioSelectView.prototype.onRender = function() {
      if (!(this.collection.length <= 1)) {
        return this.$el.removeAttr('disabled');
      }
    };

    return MunicipioSelectView;

  })(SelectItemView);

  UbsCollection = (function(_super) {
    __extends(UbsCollection, _super);

    function UbsCollection() {
      return UbsCollection.__super__.constructor.apply(this, arguments);
    }

    UbsCollection.prototype.url = function() {
      return "//dms.ufpel.edu.br/casca/ubs/busca/codibge/" + this.ibge;
    };

    UbsCollection.prototype.parse = function(ubss) {
      return this.reset([dummy()].concat(ubss.map(function(i) {
        return {
          value: i.cnes,
          text: i.nome
        };
      })));
    };

    return UbsCollection;

  })(Backbone.Collection);

  UbsSelectView = (function(_super) {
    __extends(UbsSelectView, _super);

    function UbsSelectView() {
      return UbsSelectView.__super__.constructor.apply(this, arguments);
    }

    UbsSelectView.prototype.events = {
      'change': 'mostra'
    };

    UbsSelectView.prototype.initialize = function() {
      return this.listenTo(this.collection, 'reset', this.render);
    };

    UbsSelectView.prototype.mostra = function() {};

    UbsSelectView.prototype.onBeforeRender = function() {
      return this.$el.empty().attr({
        disabled: 'disabled'
      });
    };

    UbsSelectView.prototype.onRender = function() {
      if (!(this.collection.length <= 1)) {
        return this.$el.removeAttr('disabled');
      }
    };

    return UbsSelectView;

  })(SelectItemView);

  DemoAppFormLocal = (function(_super) {
    __extends(DemoAppFormLocal, _super);

    function DemoAppFormLocal() {
      return DemoAppFormLocal.__super__.constructor.apply(this, arguments);
    }

    DemoAppFormLocal.prototype.regions = {
      container: '.local-form-container'
    };

    DemoAppFormLocal.prototype.initialize = function() {
      return this.container.show(new UbsFormLayout);
    };

    return DemoAppFormLocal;

  })(Marionette.Application);

  new DemoAppFormLocal;

}).call(this);
