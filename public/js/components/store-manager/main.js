// Generated by CoffeeScript 1.8.0
define(['./controller', './routes'], function(controller, routes) {
  var url;
  url = {
    'host': window.location.host,
    'path': 'arouca/modulo/maad-paliativo'
  };
  return function(component, parentApp, Backbone, Marionette, $, _) {
    var enviaUserEnquete;
    App.commands.setHandler('storeUser', function(user, cb) {
      var local, progresso, resposta, socket;
      if (user == null) {
        user = App.user;
      }
      local = parentApp.local, socket = parentApp.socket, progresso = parentApp.progresso;
      if (!user) {
        return false;
      }
      parentApp.user = user;
      if (local) {
        local.set('user', parentApp.user);
      }
      progresso.setUser(user);
      resposta = {
        ok: false
      };
      if (socket) {
        user['modulo'] = App.moduloId;
        console.log("emit user", user);
        return socket.emit('user', user, function(resposta) {
          var erroServidor, u;
          console.log("SALVO USER no server", resposta);
          if (resposta.ok) {
            if (resposta.user.cpf !== user.cpf) {
              resposta.ok = false;
              erroServidor = "Conflito de cpf enviado: " + user.cpf + " recebido " + resposta.user.cpf;
              socket.emit('senderror', erroServidor, function(r) {});
              if (cb) {
                return cb(resposta);
              }
            } else {
              u = resposta.user;
              App.user = u;
              App.local.set('user', App.user);
              return App.execute('retrieveRespostas', cb);
            }
          } else {
            if (cb) {
              return cb(resposta);
            }
          }
        });
      } else {
        if (cb) {
          return cb(resposta);
        }
      }
    });
    App.commands.setHandler('retrieveRespostas', function(cb) {
      var cpfUser, local, obj, progresso, respostaz, resps, respsServer, socket, ts, user, _ref;
      user = parentApp.user, local = parentApp.local, socket = parentApp.socket, progresso = parentApp.progresso;
      if (socket && local && user) {
        respostaz = App.local.get('respostas-' + App.user.cpf) ? App.local.get('respostas-' + App.user.cpf) : [];
        respsServer = [];
        resps = _.sortBy(respostaz, 'ts');
        ts = resps ? (_ref = resps[0]) != null ? _ref.ts : void 0 : 0;
        cpfUser = parentApp.progresso.user.get('cpf');
        obj = {
          user: cpfUser,
          modulo: window.modulo._id
        };
        return socket.emit('respostas:rebuild', resps, function(data) {
          var respsLocais, _ref1;
          if (!data.ok) {
            if (cb) {
              return cb(data);
            } else {
              return (_ref1 = App.main.currentView) != null ? _ref1.render() : void 0;
            }
          }
          if (data.respostas.length > 0) {
            respsLocais = data.respostas;
          }
          return socket.emit('respostas', obj, function(data) {
            var ok, respostas, _ref2;
            ok = data.ok, respostas = data.respostas;
            if (!ok) {
              if (cb) {
                return cb(data);
              }
            }
            if (!data.respostas) {
              data.respostas = respsLocais;
            }
            App.progresso.reset(data.respostas);
            if (cb) {
              return cb(data);
            } else {
              return (_ref2 = App.main.currentView) != null ? _ref2.render() : void 0;
            }
          });
        });
      }
    });
    App.commands.setHandler('loginComo', function(cpf, cb) {
      var local, progresso, socket;
      local = parentApp.local, socket = parentApp.socket, progresso = parentApp.progresso;
      return socket.emit('getuser', {
        cpf: cpf
      }, function(resposta) {
        var erroServidor, u;
        if (resposta.ok) {
          if (resposta.user.cpf !== cpf) {
            erroServidor = "Conflito (loginComo) de cpf enviado: " + cpf + " recebido " + resposta.user.cpf;
            socket.emit('senderror', erroServidor, function(r) {});
          }
          u = resposta.user;
          App.user = u;
          App.local.set('user', App.user);
          App.progresso.setUser(App.user);
          return App.execute('retrieveRespostas', function() {
            return window.location.reload();
          });
        } else {
          return console.log("Error:", resposta);
        }
      });
    });
    App.commands.setHandler('storeUserEnquete', function(userEnquete, cb) {
      var local, progresso, socket;
      local = parentApp.local, socket = parentApp.socket, progresso = parentApp.progresso;
      if (!userEnquete) {
        return false;
      }
      if (!App.user) {
        return socket.emit('getuser', {
          cpf: userEnquete.cpf,
          modulo: App.moduloId
        }, function(resposta) {
          var erroServidor;
          if (resposta.ok) {
            App.user = resposta.user;
            return enviaUserEnquete(userEnquete, cb);
          } else {
            erroServidor = "Não foi possivel salvar a enquete para: " + userEnquete.cpf;
            return socket.emit('senderror', erroServidor, function(r) {});
          }
        });
      } else {
        return enviaUserEnquete(userEnquete, cb);
      }
    });
    App.commands.setHandler('dashboard.calcProgresso', function(cb) {
      return App.socket.emit('dashboard.calcProgresso', App.user.cpf, App.moduloId, cb);
    });
    return enviaUserEnquete = function(userEnquete, cb) {
      var local, progresso, resposta, socket;
      local = parentApp.local, socket = parentApp.socket, progresso = parentApp.progresso;
      if (!App.user.enquetes) {
        App.user.enquetes = {};
      }
      if (!App.user.enquetes[App.moduloId]) {
        App.user.enquetes[App.moduloId] = {};
      }
      if (userEnquete.cadastro) {
        App.user.enquetes[App.moduloId]['cadastro'] = userEnquete.cadastro;
      }
      if (userEnquete.conclusao) {
        App.user.enquetes[App.moduloId]['conclusao'] = userEnquete.conclusao;
      }
      if (userEnquete.encerramento) {
        App.user.enquetes[App.moduloId]['encerramento'] = userEnquete.encerramento;
      }
      parentApp.user = App.user;
      if (local) {
        local.set('user', parentApp.user);
      }
      resposta = {
        ok: false
      };
      if (socket) {
        return socket.emit('userEnquete', App.user, function(resposta) {
          var erroServidor;
          if (!resposta.ok) {
            erroServidor = "Não foi possível salvar suas respostas!";
            socket.emit('senderror', erroServidor, function(r) {});
            if (cb) {
              return cb(resposta);
            }
          } else {
            if (cb) {
              return cb(resposta);
            }
          }
        });
      } else {
        if (cb) {
          return cb(resposta);
        }
      }
    };
  };
});
