// Generated by CoffeeScript 1.8.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['backbone.modal', 'utils', 'uf_municipios'], function(ModalView, utils, Uf) {
  var Modal;
  return Modal = (function(_super) {
    __extends(Modal, _super);

    function Modal() {
      return Modal.__super__.constructor.apply(this, arguments);
    }

    Modal.prototype.initialize = function(cpf) {
      if (App.user) {
        this.cpf = App.user.cpf;
      } else {
        this.cpf = cpf;
      }
      return console.log(this.cpf, 'cpf');
    };

    Modal.prototype.template = _.template($('#enquetes-conclusao').html());

    Modal.prototype.submitEl = '.submit-form';

    Modal.prototype.cancelEl = '.close-modal';

    Modal.prototype.onRender = function() {
      var b;
      b = $('body');
      if (!b.is(':visible')) {
        b.fadeIn();
      }
      setTimeout((function() {
        return window.$.material.init();
      }), 10);
      return this.marcaRespostas();
    };

    Modal.prototype.marcaRespostas = function() {
      var enquete, self;
      self = this;
      if (App.user.enquetes) {
        if (App.user.enquetes[App.moduloId]) {
          enquete = App.user.enquetes[App.moduloId].conclusao;
          if (enquete) {
            self.$el.find('input[name=optionRadios11][value=' + enquete['pergunta11'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios12][value=' + enquete['pergunta12'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios13][value=' + enquete['pergunta13'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios2][value=' + enquete['pergunta2'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios31][value=' + enquete['pergunta31'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios32][value=' + enquete['pergunta32'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios33][value=' + enquete['pergunta33'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios34][value=' + enquete['pergunta34'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios35][value=' + enquete['pergunta35'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios36][value=' + enquete['pergunta36'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios37][value=' + enquete['pergunta37'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios41][value=' + enquete['pergunta41'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios42][value=' + enquete['pergunta42'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios43][value=' + enquete['pergunta43'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios44][value=' + enquete['pergunta44'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios45][value=' + enquete['pergunta45'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios5][value=' + enquete['pergunta5'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios6][value=' + enquete['pergunta6'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios71][value=' + enquete['pergunta71'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios72][value=' + enquete['pergunta72'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios73][value=' + enquete['pergunta73'] + ']').prop('checked', true);
            return self.$el.find('input[name=outrooptionRadios2]').val(enquete['pergunta2outro']);
          }
        }
      }
    };

    Modal.prototype.onDestroy = function() {
      $('body').removeAttr('style').css({
        display: 'block'
      });
      $('body').css({
        'overflow': 'auto'
      });
      if (App.user) {
        if (!App.user.enquetes) {
          App.user['enquetes'] = {};
        }
        if (!App.user.enquetes[App.moduloId]) {
          App.user.enquetes[App.moduloId] = {};
        }
        if (!App.user.enquetes[App.moduloId].conclusao) {
          App.user.enquetes[App.moduloId].conclusao = {
            'naodesejoresponder': true
          };
          App.execute('storeUserEnquete', {
            cpf: App.user.cpf,
            modulo: App.moduloId,
            conclusao: App.user.enquetes[App.moduloId].conclusao
          }, function(resposta) {
            return console.log('nao desejo responder salvo server', resposta);
          });
        }
      }
      return Backbone.history.navigate('#comp/progresso', {
        trigger: true
      });
    };

    Modal.prototype.beforeSubmit = function(ev) {
      var validUser;
      console.log('submit-form');
      this.hadFocus = this.$el.find('a.btn.submit-form');
      this.$el.find('.btn').attr('disabled', true);
      this.$el.find('input').attr('disabled', true);
      this.$el.find('select').attr('disabled', true);
      validUser = this.validaForm(false);
      if (validUser) {
        this.salvaUser(validUser);
      } else {
        this.$el.find('.btn').removeAttr('disabled');
        this.$el.find('input').removeAttr('disabled');
        this.$el.find('select').removeAttr('disabled');
      }
      return false;
    };

    Modal.prototype.events = {
      'click #fechar-enquete-conclusao': 'destroy'
    };

    Modal.prototype.exibeErro = function(mensagemErro) {
      this.$el.find('.alert').addClass('alert-danger');
      this.$el.find('.alert').empty();
      this.$el.find('.alert').append(mensagemErro);
      return this.$el.find('.alert').show();
    };

    Modal.prototype.limpaError = function(evt) {
      this.$el.find('.alert').removeClass('alert-warning alert-success').hide();
      $('.has-error').removeClass('has-error');
      $('.has-success').removeClass('has-success');
      return $('.has-warning').removeClass('has-warning');
    };

    Modal.prototype.concorda = function(evt) {
      var chk, el;
      el = $(evt.target);
      chk = el.attr('checked');
      if (chk === 'checked') {
        return el.removeAttr('checked');
      }
      return el.attr('checked', 'checked');
    };

    Modal.prototype.validaForm = function(silent) {
      var campoProblema, enquete, mensagemErro, self;
      if (silent == null) {
        silent = true;
      }
      self = this;
      campoProblema = [];
      mensagemErro = '';
      if (!self.$el.find('input[name=optionRadios11]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios11]'));
        self.$el.find('input[name=optionRadios11]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 1.1 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios12]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios12]'));
        self.$el.find('input[name=optionRadios12]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 1.2 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios13]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios13]'));
        self.$el.find('input[name=optionRadios13]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 1.3 não foi respondida.<br>';
      }
      if ((!self.$el.find('input[name=optionRadios2]:checked').val()) || (!self.$el.find('input[name=outrooptionRadios2]').val() && self.$el.find('input[name=optionRadios2]:checked').val() === 'outro')) {
        if (!self.$el.find('input[name=outrooptionRadios2]').val() && self.$el.find('input[name=optionRadios2]:checked').val() === 'outro') {
          campoProblema.push(self.$el.find('input[name=outrooptionRadios2]'));
          self.$el.find('input[name=outrooptionRadios2]').parent().parent().addClass('has-error');
          mensagemErro += 'A pergunta 2 não foi respondida completamente. Especifique a outra opção.<br>';
        } else {
          campoProblema.push(self.$el.find('input[name=optionRadios2]'));
          self.$el.find('input[name=optionRadios2]').parent().parent().addClass('has-error');
          mensagemErro += 'A pergunta 2 não foi respondida.<br>';
        }
      }
      if (!self.$el.find('input[name=optionRadios31]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios31]'));
        self.$el.find('input[name=optionRadios31]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.1 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios32]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios32]'));
        self.$el.find('input[name=optionRadios32]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.2 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios33]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios33]'));
        self.$el.find('input[name=optionRadios33]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.3 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios34]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios34]'));
        self.$el.find('input[name=optionRadios34]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.4 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios35]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios35]'));
        self.$el.find('input[name=optionRadios35]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.5 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios36]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios36]'));
        self.$el.find('input[name=optionRadios36]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.6 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios37]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios37]'));
        self.$el.find('input[name=optionRadios37]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.7 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios38]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios38]'));
        self.$el.find('input[name=optionRadios38]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3.8 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios41]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios41]'));
        self.$el.find('input[name=optionRadios41]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 4.1 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios42]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios42]'));
        self.$el.find('input[name=optionRadios42]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 4.2 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios43]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios43]'));
        self.$el.find('input[name=optionRadios43]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 4.3 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios44]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios44]'));
        self.$el.find('input[name=optionRadios44]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 4.4 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios45]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios45]'));
        self.$el.find('input[name=optionRadios45]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 4.5 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios5]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios5]'));
        self.$el.find('input[name=optionRadios5]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 5 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios6]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios6]'));
        self.$el.find('input[name=optionRadios6]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 6 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios71]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios71]'));
        self.$el.find('input[name=optionRadios71]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 7.1 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios72]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios72]'));
        self.$el.find('input[name=optionRadios72]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 7.2 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios73]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios73]'));
        self.$el.find('input[name=optionRadios73]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 7.3 não foi respondida.<br>';
      }
      if (campoProblema.length > 0) {
        this.$el.find('input').attr('disabled', false);
        this.$el.find('select').attr('disabled', false);
        this.exibeErro(mensagemErro);
        if (this.hadFocus.is('a.btn.submit-form')) {
          campoProblema[0].focus();
        }
        return false;
      } else {
        enquete = {
          'pergunta11': self.$el.find('input[name=optionRadios11]:checked').val(),
          'pergunta12': self.$el.find('input[name=optionRadios12]:checked').val(),
          'pergunta13': self.$el.find('input[name=optionRadios13]:checked').val(),
          'pergunta2': self.$el.find('input[name=optionRadios2]:checked').val(),
          'pergunta2outro': self.$el.find('input[name=outrooptionRadios2]').val(),
          'pergunta31': self.$el.find('input[name=optionRadios31]:checked').val(),
          'pergunta32': self.$el.find('input[name=optionRadios32]:checked').val(),
          'pergunta33': self.$el.find('input[name=optionRadios33]:checked').val(),
          'pergunta34': self.$el.find('input[name=optionRadios34]:checked').val(),
          'pergunta35': self.$el.find('input[name=optionRadios35]:checked').val(),
          'pergunta36': self.$el.find('input[name=optionRadios36]:checked').val(),
          'pergunta37': self.$el.find('input[name=optionRadios37]:checked').val(),
          'pergunta41': self.$el.find('input[name=optionRadios41]:checked').val(),
          'pergunta42': self.$el.find('input[name=optionRadios42]:checked').val(),
          'pergunta43': self.$el.find('input[name=optionRadios43]:checked').val(),
          'pergunta44': self.$el.find('input[name=optionRadios44]:checked').val(),
          'pergunta45': self.$el.find('input[name=optionRadios45]:checked').val(),
          'pergunta5': self.$el.find('input[name=optionRadios5]:checked').val(),
          'pergunta6': self.$el.find('input[name=optionRadios6]:checked').val(),
          'pergunta71': self.$el.find('input[name=optionRadios71]:checked').val(),
          'pergunta72': self.$el.find('input[name=optionRadios72]:checked').val(),
          'pergunta73': self.$el.find('input[name=optionRadios73]:checked').val()
        };
      }
      console.log(enquete, 'respostas');
      return {
        'cpf': this.cpf,
        'modulo': App.moduloId,
        'conclusao': enquete
      };
    };

    Modal.prototype.salvaUser = function(user) {
      var destroyCallback, self;
      self = this;
      self.$el.find('input').attr('disabled', true);
      self.$el.find('select').attr('disabled', true);
      self.$el.find('.alert').removeClass('alert-danger').addClass('alert-success').empty();
      destroyCallback = function() {
        if (App.modals.currentView) {
          setTimeout((function() {
            return App.modals.destroyAll();
          }), 1);
        }
        if (!App.main.currentView) {
          return Backbone.history.navigate('#', {
            trigger: true
          });
        }
      };
      self.$el.find('.alert').html('<h3>Enquete salva neste navegador</h3>');
      self.$el.find('.btn').attr('disabled', true);
      console.log(user, 'user');
      return App.execute('storeUserEnquete', user, function(resposta) {
        var erro;
        if (resposta.ok) {
          $('.dropdown-componentes').find('ul.dropdown-menu li').show();
          self.$el.find('.alert').html('<h3>Respostas da enquete salvas no servidor</h3>');
          self.$el.find('.alert').show();
          self.$el.find('.btn').hide();
          return setTimeout(destroyCallback(), 1000);
        } else {
          self.$el.find('.alert').removeClass('alert-success').addClass('alert-danger').empty();
          erro = '<h3>' + resposta.msg + '</h3>';
          self.$el.find('.btn').attr('disabled', false);
          self.$el.find('.alert').html(erro);
          return self.$el.find('.alert').show();
        }
      });
    };

    return Modal;

  })(Backbone.Modal);
});
