// Generated by CoffeeScript 1.8.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['backbone.modal', 'utils', 'uf_municipios'], function(ModalView, utils, Uf) {
  var Modal;
  return Modal = (function(_super) {
    __extends(Modal, _super);

    function Modal() {
      return Modal.__super__.constructor.apply(this, arguments);
    }

    Modal.prototype.initialize = function(cpf) {
      if (App.user) {
        this.cpf = App.user.cpf;
      } else {
        this.cpf = cpf;
      }
      return console.log(this.cpf, 'cpf');
    };

    Modal.prototype.template = _.template($('#enquetes-cadastro').html());

    Modal.prototype.submitEl = '.submit-form';

    Modal.prototype.cancelEl = '.close-modal';

    Modal.prototype.onRender = function() {
      var b;
      b = $('body');
      if (!b.is(':visible')) {
        b.fadeIn();
      }
      setTimeout((function() {
        return window.$.material.init();
      }), 10);
      return this.marcaRespostas();
    };

    Modal.prototype.marcaRespostas = function() {
      var enquete, self;
      self = this;
      if (App.user.enquetes) {
        if (App.user.enquetes[App.moduloId]) {
          enquete = App.user.enquetes[App.moduloId].cadastro;
          if (enquete) {
            self.$el.find('input[name=optionRadios1][value=' + enquete['pergunta1'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios21][value=' + enquete['pergunta21'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios22][value=' + enquete['pergunta22'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios23][value=' + enquete['pergunta23'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios24][value=' + enquete['pergunta24'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios25][value=' + enquete['pergunta25'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios3][value=' + enquete['pergunta3'] + ']').prop('checked', true);
            self.$el.find('input[name=optionRadios4][value=' + enquete['pergunta4'] + ']').prop('checked', true);
            self.$el.find('input[name=outrooptionRadios4]').val(enquete['pergunta4outro']);
            return self.$el.find('input[name=outrooptionRadios1]').val(enquete['pergunta1outro']);
          }
        }
      }
    };

    Modal.prototype.naoDesejo = function() {
      $('body').removeAttr('style').css({
        display: 'block'
      });
      $('body').css({
        'overflow': 'auto'
      });
      if (App.user) {
        if (!App.user.enquetes) {
          App.user['enquetes'] = {};
        }
        if (!App.user.enquetes[App.moduloId]) {
          App.user.enquetes[App.moduloId] = {};
        }
        if (!App.user.enquetes[App.moduloId].cadastro) {
          App.user.enquetes[App.moduloId].cadastro = {
            'naodesejoresponder': true
          };
        }
        this.destroy();
        Backbone.history.navigate('#comp/home', {
          trigger: true
        });
        return App.execute('storeUserEnquete', {
          cpf: App.user.cpf,
          modulo: App.moduloId,
          cadastro: App.user.enquetes[App.moduloId].cadastro
        }, function(resposta) {
          return console.log('nao desejo responder salvo server', resposta);
        });
      }
    };

    Modal.prototype.beforeSubmit = function(ev) {
      var validUser;
      console.log('submit-form');
      this.hadFocus = this.$el.find('a.btn.submit-form');
      this.$el.find('.btn').attr('disabled', true);
      this.$el.find('input').attr('disabled', true);
      this.$el.find('select').attr('disabled', true);
      validUser = this.validaForm(false);
      if (validUser) {
        this.salvaUser(validUser);
      } else {
        this.$el.find('.btn').removeAttr('disabled');
        this.$el.find('input').removeAttr('disabled');
        this.$el.find('select').removeAttr('disabled');
      }
      return false;
    };

    Modal.prototype.events = {
      'click #fechar-enquete-cadastro': 'naoDesejo'
    };

    Modal.prototype.exibeErro = function(mensagemErro, erro) {
      if (erro == null) {
        erro = false;
      }
      if (!erro) {
        this.$el.find('.alert').removeClass('alert-success').addClass('alert-danger').empty();
      } else {
        this.$el.find('.alert').removeClass('alert-danger').addClass('alert-sucess').empty();
        this.$el.find('.btn').attr('disabled', false);
      }
      this.$el.find('input').attr('disabled', false);
      this.$el.find('select').attr('disabled', false);
      this.$el.find('.alert').append(mensagemErro);
      return this.$el.find('.alert').show();
    };

    Modal.prototype.limpaError = function(evt) {
      this.$el.find('.alert').removeClass('alert-warning alert-success').hide();
      $('.has-error').removeClass('has-error');
      $('.has-success').removeClass('has-success');
      return $('.has-warning').removeClass('has-warning');
    };

    Modal.prototype.concorda = function(evt) {
      var chk, el;
      el = $(evt.target);
      chk = el.attr('checked');
      if (chk === 'checked') {
        return el.removeAttr('checked');
      }
      return el.attr('checked', 'checked');
    };

    Modal.prototype.validaForm = function(silent) {
      var campoProblema, enquete, mensagemErro, self;
      if (silent == null) {
        silent = true;
      }
      self = this;
      self.limpaError();
      campoProblema = [];
      mensagemErro = '';
      if ((!self.$el.find('input[name=optionRadios1]:checked').val()) || (!self.$el.find('input[name=outrooptionRadios1]').val() && self.$el.find('input[name=optionRadios1]:checked').val() === 'outro')) {
        if (!self.$el.find('input[name=outrooptionRadios1]').val() && self.$el.find('input[name=optionRadios1]:checked').val() === 'outro') {
          campoProblema.push(self.$el.find('input[name=outrooptionRadios1]'));
          self.$el.find('input[name=outrooptionRadios1]').parent().parent().addClass('has-error');
          mensagemErro += 'A pergunta 1 não foi respondida completamente. Especifique a outra opção.<br>';
        } else {
          campoProblema.push(self.$el.find('input[name=optionRadios1]'));
          self.$el.find('input[name=optionRadios1]').parent().parent().addClass('has-error');
          mensagemErro += 'A pergunta 1 não foi respondida.<br>';
        }
      }
      if (!self.$el.find('input[name=optionRadios21]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios21]'));
        self.$el.find('input[name=optionRadios21]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 2.1 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios22]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios22]'));
        self.$el.find('input[name=optionRadios22]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 2.2 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios23]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios23]'));
        self.$el.find('input[name=optionRadios23]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 2.3 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios24]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios24]'));
        self.$el.find('input[name=optionRadios24]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 2.4 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios25]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios25]'));
        self.$el.find('input[name=optionRadios25]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 2.5 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios3]:checked').val()) {
        campoProblema.push(self.$el.find('input[name=optionRadios3]'));
        self.$el.find('input[name=optionRadios3]').parent().parent().addClass('has-error');
        mensagemErro += 'A pergunta 3 não foi respondida.<br>';
      }
      if (!self.$el.find('input[name=optionRadios4]:checked').val() || (!self.$el.find('input[name=outrooptionRadios4]').val() && self.$el.find('input[name=optionRadios4]:checked').val() === 'outro')) {
        if (!self.$el.find('input[name=outrooptionRadios4]').val() && self.$el.find('input[name=optionRadios4]:checked').val() === 'outro') {
          campoProblema.push(self.$el.find('input[name=outrooptionRadios4]'));
          self.$el.find('input[name=outrooptionRadios4]').addClass('has-error');
          mensagemErro += 'A pergunta 4 não foi respondida completamente. Especifique a outra opção.<br>';
        } else {
          campoProblema.push(self.$el.find('input[name=optionRadios4]'));
          self.$el.find('input[name=optionRadios4]').parent().parent().addClass('has-error');
          mensagemErro += 'A pergunta 4 não foi respondida.<br>';
        }
      }
      console.log(campoProblema, 'campoProblema');
      if (campoProblema.length > 0) {
        this.$el.find('input').attr('disabled', false);
        this.$el.find('select').attr('disabled', false);
        this.exibeErro(mensagemErro);
        if (this.hadFocus.is('a.btn.submit-form')) {
          campoProblema[0].focus();
        }
        return false;
      } else {
        enquete = {
          'pergunta1': self.$el.find('input[name=optionRadios1]:checked').val(),
          'pergunta1outro': self.$el.find('input[name=outrooptionRadios1]').val(),
          'pergunta21': self.$el.find('input[name=optionRadios21]:checked').val(),
          'pergunta22': self.$el.find('input[name=optionRadios22]:checked').val(),
          'pergunta23': self.$el.find('input[name=optionRadios23]:checked').val(),
          'pergunta24': self.$el.find('input[name=optionRadios24]:checked').val(),
          'pergunta25': self.$el.find('input[name=optionRadios25]:checked').val(),
          'pergunta3': self.$el.find('input[name=optionRadios3]:checked').val(),
          'pergunta4': self.$el.find('input[name=optionRadios4]:checked').val(),
          'pergunta4outro': self.$el.find('input[name=outrooptionRadios4]').val()
        };
      }
      console.log(enquete, 'respostas');
      return {
        'cpf': this.cpf,
        'modulo': App.moduloId,
        'cadastro': enquete
      };
    };

    Modal.prototype.salvaUser = function(user) {
      var destroyCallback, self;
      self = this;
      self.$el.find('input').attr('disabled', true);
      self.$el.find('select').attr('disabled', true);
      self.$el.find('.alert').removeClass('alert-danger').addClass('alert-success').empty();
      user.synced = false;
      destroyCallback = function() {
        if (App.modals.currentView) {
          setTimeout((function() {
            return App.modals.destroyAll();
          }), 1);
        }
        return Backbone.history.navigate('/', {
          trigger: true
        });
      };
      self.$el.find('.alert').html('<h3>Enquete salva neste navegador</h3>');
      self.$el.find('.btn').attr('disabled', true);
      return App.execute('storeUserEnquete', user, function(resposta) {
        var erro;
        if (resposta.ok) {
          $('.dropdown-componentes').find('ul.dropdown-menu li').show();
          erro = '<h3>Respostas da enquete salvas no servidor</h3>';
          self.exibeErro(erro, false);
          return setTimeout(destroyCallback(), 1000);
        } else {
          erro = '<h3>' + resposta.msg + '</h3>';
          return self.exibeErro(erro, true);
        }
      });
    };

    return Modal;

  })(Backbone.Modal);
});
