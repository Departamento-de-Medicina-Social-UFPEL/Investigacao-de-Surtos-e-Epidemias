// Generated by CoffeeScript 1.8.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['../models/Monitoramento'], function(Monitoramento) {
  var Monitoramentos;
  return Monitoramentos = (function(_super) {
    __extends(Monitoramentos, _super);

    function Monitoramentos() {
      return Monitoramentos.__super__.constructor.apply(this, arguments);
    }

    Monitoramentos.prototype['model'] = Monitoramento;

    Monitoramentos.prototype['url'] = '';

    Monitoramentos.prototype['initialize'] = function(options) {};

    Monitoramentos.prototype['addAmostra'] = function(a) {
      var dados, jaexiste, l;
      l = this.get(a.id_local);
      dados = l.get('dados');
      dados.forEach(function(d) {
        var dt_fim_a, dt_fim_d, dt_ini_a, dt_ini_d;
        if (l.tipo === 'dia') {
          if (a.periodoInicio === d.periodoInicio) {
            throw "J치 existe dados na base para o dia informado!";
          }
        } else {
          dt_ini_a = new Date(a.periodoInicio);
          dt_fim_a = new Date(a.periodoFim);
          dt_ini_d = new Date(a.periodoInicio);
          dt_fim_d = new Date(a.periodoFim);
          if (dt_ini_a >= dt_ini_d && dt_ini_a <= dt_fim_d) {
            throw "A data de inicio da amostra esta coberto por outra amostra j치 inserida!";
          }
          if (dt_fim_a >= dt_ini_d && dt_fim_a <= dt_fim_d) {
            throw "A data de fim da amostra esta coberto por outra amostra j치 inserida!";
          }
          if (dt_fim_a <= dt_ini_d && dt_fim_a >= dt_fim_d) {
            throw "Operiodo da amostra esta contendo uma outra amostra j치 inserida!";
          }
        }
      });
      if (!a.id) {
        a['id'] = a.id_local + '_' + (a.periodoInicio.split('/').join('_'));
      }
      jaexiste = false;
      dados = dados.map((function(_this) {
        return function(d) {
          if (d.id === a.id) {
            jaexiste = true;
            return a;
          } else {
            return d;
          }
        };
      })(this));
      if (!jaexiste) {
        dados.push(a);
      }
      l.set('dados', dados);
      return this.update(l);
    };

    Monitoramentos.prototype['create'] = function(l) {
      l.dados = [];
      if (!l.tipo) {
        l['tipo'] = 'dia';
      }
      console.log(l, 'moni', l['tipo']);
      this.add(l);
      this.saveLocal();
      return this.get(l.id);
    };

    Monitoramentos.prototype['update'] = function(l) {
      this.models = this.models.map((function(_this) {
        return function(m) {
          if (l.get('id') === m.get('id')) {
            m = l;
          }
          return m;
        };
      })(this));
      console.log('update', l.get('dados'));
      return this.saveLocal();
    };

    Monitoramentos.prototype['excluir'] = function(id) {
      var local;
      local = this.remove(id);
      return this.saveLocal();
    };

    Monitoramentos.prototype.saveLocal = function() {
      var local, user;
      if (!App.local) {
        return;
      }
      local = App.local, user = App.user;
      return local.set("monitoramento-" + user.cpf, this.toJSON());
    };

    Monitoramentos.prototype.saveServer = function(res) {
      if (!App.socket) {
        return;
      }
      return App.socket.emit("monitorou", res.toJSON(), function(data) {
        return console.log(data);
      });
    };

    return Monitoramentos;

  })(Backbone.Collection);
});
