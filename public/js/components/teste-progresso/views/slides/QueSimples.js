// Generated by CoffeeScript 2.7.0
define([], function() {
  var SlideQueSimples;
  SlideQueSimples = (function() {
    class SlideQueSimples extends Marionette.ItemView {
      initialize() {}

      template(data) {
        var opcs;
        if (_.isArray(data.conteudo.opcoes[0])) {
          opcs = data.conteudo.opcoes.map(function(arrOp, i) {
            return {
              correta: arrOp[1],
              texto: arrOp[0],
              originalIdx: i
            };
          });
          // console.log 'data.dontShuffle----------->', data.dontShuffle
          if (!data.dontShuffle) {
            data.conteudo.opcoes = _.shuffle(opcs);
          } else {
            data.conteudo.opcoes = opcs;
          }
        }
        return _.template($('script#teste-progresso-slides-queSimples').html())(data);
      }

      respondeu(evt) {
        if (!this.ehTocado) {
          evt.stopPropagation();
          evt.preventDefault();
          return false;
        }
        this.ui.opts.bind('click', function() {
          return false;
        });
        this.ui.btnResp.hide();
        this.ui.opts.addClass('disabled').css({
          color: '#888'
        }).on('click', function() {
          return false;
        });
        this.ui.opts.find(':input').attr('tabIndex', '-1');
        return this.corrige();
      }

      onRender() {
        this.ui.btnResp.addClass('disabled btn-default');
        this.ui.btnResp.text('Selecione');
        return this.verificaConcluinte();
      }

      tocado(evt) {
        if (this.ehTocado) {
          // if !@respondido and /label/img.test evt.target.tagName
          //   $(evt.target).find('input').prop 'checked', true
          return true;
        }
        this.ehTocado = true;
        return this.ui.btnResp.removeClass('disabled btn-default').addClass('btn-info').text('Responder');
      }

      getMarcada() {
        var m;
        m = this.ui.opts.find('input:checked');
        // console.log  m
        return m.data('originalidx');
      }

      getCorreta() {
        var j, len, o, ops;
        ops = this.model.get('conteudo').opcoes;
        for (j = 0, len = ops.length; j < len; j++) {
          o = ops[j];
          if (o.correta) {
            return o.originalIdx;
          }
        }
      }

      corrige() {
        var acertoBadge, acertou, azul, badge, conceito, corr, div, ico, labelOpcaoCorr, labelOpcaoMar, media, page, resp, salvaResposta, score, scoreAtu, self, strConceito, tipo, totalScore, verde, vermelho;
        self = this;
        corr = this.getCorreta();
        resp = this.getMarcada();
        // console.log "#{corr} is #{resp}"
        acertou = corr === resp;
        labelOpcaoCorr = this.ui.opts.find(`:input[data-originalidx="${corr}"]`).parent();
        labelOpcaoMar = this.ui.opts.find(`:input[data-originalidx="${resp}"]`).parent();
        // console.log labelOpcaoCorr, labelOpcaoMar
        [vermelho, azul, verde] = ['#e74c3c', '#3498db', '#27ae60'];
        if (acertou) {
          labelOpcaoCorr.css('color', verde);
        } else {
          labelOpcaoCorr.css('color', azul);
          labelOpcaoMar.css('color', vermelho);
        }
        conceito = $('li.score');
        scoreAtu = parseInt(conceito.data('score'));
        if (!scoreAtu) {
          scoreAtu = 0;
        }
        // conceito.find('.tit-conceito').text('Conceito') if scoreAtu is 0
        media = acertou ? 100 : 0;
        totalScore = scoreAtu + media;
        div = 2;
        if (scoreAtu === 0) {
          div = 1;
        }
        score = totalScore / div;
        conceito.data('score', score);
        // console.log "score #{score} = (#{totalScore} = #{scoreAtu} + #{media}) / #{div}"
        strConceito = this.getConceito(score);
        conceito.find('.conceito').text(strConceito);
        if (!this.silent) {
          console.log(this.model.collection);
          salvaResposta = {
            atividade: this.model.collection.caso.get('_id'),
            seqid: this.$el.data('seqid'),
            modulo: window.modulo._id,
            marcadas: [this.getMarcada()],
            escore: media,
            ts: Date.now()
          };
          if (App.user) {
            App.progresso.create(salvaResposta);
          }
          page = $('html, body');
          page.on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function() {
            page.stop();
            return page.off("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove");
          });
          page.animate({
            scrollTop: self.$el.find('.opcoes').offset().top - 85
          }, 300, function() {
            return page.off("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove");
          });
        }
        badge = $('li.quest > span[target="' + this.$el.prop('id') + '"]');
        badge.addClass('corrigido');
        this.ui.acerto.text(acertou ? 'Acertou' : 'Incorreto');
        ico = acertou ? 'checkbox-marked-circle' : 'emoticon-sad';
        tipo = acertou ? 'success' : 'danger';
        acertoBadge = acertou ? 'correto' : 'errado';
        this.ui.corrIco.addClass(`mdi-${ico}`);
        this.ui.correcao.addClass(`alert-${tipo} in`).removeClass('out hide');
        if (this.model.get('conteudo').resposta.texto) {
          this.ui.saiba.addClass('in').removeClass('out hide');
        }
        badge.addClass(`${acertoBadge}`);
        this.respondido = true;
        return this.trigger('respondeu', this);
      }

      ['getConceito'](conceito) {
        switch (false) {
          case !(conceito >= 95):
            return 'A+';
          case !(conceito >= 90):
            return 'A';
          case !(conceito >= 80):
            return 'B+';
          case !(conceito >= 70):
            return 'B';
          case !(conceito >= 60):
            return 'C+';
          case !(conceito >= 50):
            return 'C';
          case !(conceito >= 40):
            return 'D+';
          case !(conceito >= 30):
            return 'D';
          case !(conceito >= 20):
            return 'E+';
          default:
            return 'E';
        }
      }

      verificaConcluinte() {
        var self;
        self = this;
        return App.user.ofertas.forEach(function(o) {
          var nucleos;
          nucleos = self.model.get('profissional');
          if (o.modulo === App.moduloId && (nucleos.indexOf(o.conteudo) > -1 || o.conteudo === 'interdisciplinar') && o.dt_conclusao) {
            return self.ui.btnResp.hide();
          }
        });
      }

    };

    SlideQueSimples.prototype.className = 'container-fluid questao';

    SlideQueSimples.prototype.tagName = 'section';

    SlideQueSimples.prototype.ui = {
      btnResp: 'button.responder',
      opts: '.radio',
      saiba: '.resposta',
      correcao: '.alert',
      acerto: '.alert h2.acerto',
      corrIco: '.alert i'
    };

    SlideQueSimples.prototype.events = {
      'click button.responder': 'respondeu',
      'click .radio': 'tocado'
    };

    SlideQueSimples.prototype.ehTocado = false;

    SlideQueSimples.prototype.respondido = false;

    return SlideQueSimples;

  }).call(this);
  return SlideQueSimples;
});
