// Generated by CoffeeScript 1.8.0
define(['underscore', 'ppuStore'], function(_, PPUStore) {
  var PPU;
  return PPU = (function() {
    PPU.configLoaded = false;

    PPU.isInited = false;

    PPU.basePrefix = '';

    PPU.separator = '_';

    PPU.store = false;

    function PPU(options, callback) {
      var settings;
      this.callback = callback;
      settings = {
        config: this.configModel(),
        separator: '_',
        callback: function() {}
      };
      if (_.isString(options)) {
        settings.config = JSON.parse(options);
      } else {
        if (options.config) {
          settings.config = options.config;
        }
        if (options.callback) {
          this.callback = options.callback;
        }
      }
      if (options) {
        _.extend(settings, options);
      }
      this.separator = settings.separator;
      this.config = settings.config;
      this.configLoaded = true;
      this.init();
    }

    PPU.prototype.sameResourceStores = function() {
      var instAcro, lookup, name, p, sep, _ref;
      if (!this.isInited) {
        return;
      }
      p = this.config.Persistence;
      sep = this.separator;
      _ref = ['InstitutionAcronym', 'Name'].map(function(key) {
        return p[key].replace(/[_-]/img, this.separator);
      }), instAcro = _ref[0], name = _ref[1];
      lookup = new RegExp("" + instAcro + sep + "\\d{4}" + sep + name + ".*");
      return _.filter(_.keys(localStorage), function(k) {
        return lookup.test(k);
      });
    };

    PPU.prototype.init = function() {
      this.basePrefix = this.getBasePrefix();
      this.store = new PPUStore({
        'namespace': this.basePrefix,
        'separator': this.separator
      });
      this.isInited = true;
      return callback.apply(this);
    };

    PPU.prototype.getUser = function() {
      return localStorage.getItem("PPUPLAYER_USER");
    };

    PPU.prototype.getBasePrefix = function() {
      var p;
      p = this.config.Persistence;
      return [p.InstitutionAcronym, p.Version, p.Name].join(this.separator);
    };

    PPU.prototype.configModel = function() {
      return {
        'Institution': {
          'ID_Arouca': 0,
          'Acronym': '',
          'Name': ''
        },
        'Resource': {
          'Name': '',
          'Language': '',
          'CreationDate': '',
          'Review': 0,
          'ReviewDate': '1969-12-31',
          'InteractionEstimatedTimeMinutes': 0,
          'CoverImage': ''
        },
        'SupportedDevices': [''],
        'Video': {
          'Formats': [''],
          'Resolutions': ['']
        },
        'Persistence': {
          'InstitutionAcronym': '',
          'Version': '',
          'Name': '',
          'LTIValue': false
        }
      };
    };

    return PPU;

  })();
});
