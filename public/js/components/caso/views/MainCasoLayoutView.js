// Generated by CoffeeScript 2.7.0
define(['../models/Paciente', '../collections/SlidesColl', './SlidesCollView', './IntroboxView', './PacienteView', 'utils'], function(PacienteModel, SlidesColl, SlidesCollView, IntroboxView, PacienteView, utils) {
  var Caso;
  Caso = (function() {
    class Caso extends Marionette.LayoutView {
      initialize() {}

      getRespostasDeste() {
        var ref, respostas;
        console.log(`'caso' -> ${this.model.get('_id')}`);
        if (!(App.user && ((ref = App.user) != null ? ref.progresso : void 0))) {
          return null;
        }
        respostas = App.user.progresso.getByAtividadeId(this.model.get('_id'));
        if (respostas.length > 0) {
          this.model.set({respostas});
          this.assinalaMarcadas();
          return this.trigger('novasRespostas');
        }
      }

      confirmaRecomeca() {
        var self;
        self = this;
        console.log(this.ui.confirmaReset);
        this.ui.confirmaReset.modal({
          keyboard: false
        });
        return this.ui.confirmaReset.find('#delete').on('click', function() {
          var i, len, respDest, resposta;
          self.ui.confirmaReset.modal('hide');
          respDest = App.user.progresso.getByAtividadeId(self.model.get('_id'));
          for (i = 0, len = respDest.length; i < len; i++) {
            resposta = respDest[i];
            resposta.destroy();
          }
          App.user.progresso.calculaProgressoGeral();
          App.user.progresso.trigger('change');
          self.model.unset('respostas');
          self.rodapeReg.currentView.model.unset('respostas');
          App.layoutInicial.contents.currentView.render();
          self.rodapeReg.currentView.render();
          // self.model.respostas = null
          $('.modal-backdrop').removeClass('in').addClass('out').one('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd', function() {
            $('body').removeClass('modal-open');
            return $('.modal-backdrop').remove();
          });
          return true;
        });
      }

      vaiPraQuestaoDaVez() {
        return $('body').animate({
          scrollTop: $("section.slide.daVez").offset().top - 85
        }, 1000);
      }

      onRender() {
        var _this, handlerAtualizaProgresso, slidesView;
        this.paciente = new PacienteModel(this.model.get('paciente'));
        this.allSlides = new SlidesColl(this.model.get('slides'), this.paciente, this.model);
        this.addRegions({
          introReg: '.caso #introducao',
          pacienteReg: '.caso #pacienteTopo',
          slidesReg: '.caso #slidesLista'
        });
        this.pacienteReg.show(new PacienteView({
          model: this.paciente
        }));
        this.introReg.show(new IntroboxView({
          model: this.model
        }));
        slidesView = new SlidesCollView({
          collection: new SlidesColl(this.model.get('slides').slice(1), this.paciente, this.model)
        });
        this.slidesReg.show(slidesView);
        _this = this;
        handlerAtualizaProgresso = function() {
          this.getRespostasDeste();
          return this.rodapeReg.currentView.render();
        };
        this.listenTo(App.user.progresso, 'fetched', handlerAtualizaProgresso);
        this.listenTo(App.user.progresso, 'change', handlerAtualizaProgresso);
        return this.getRespostasDeste();
      }

      ['assinalaMarcadas']() {
        var casoId, mediaG, questoes, respostas, self, slides, soma, texto;
        self = this;
        if (!this.slidesReg) {
          setTimeout(function() {
            return self.assinalaMarcadas;
          }, 300);
          return null;
        }
        // @slidesReg
        casoId = this.model.get('_id');
        slides = this.slidesReg.currentView.children;
        // console.log "slides = do @slidesReg.currentView.children", slides
        respostas = this.model.get('respostas');
        if (!slides) {
          return null;
        }
        questoes = slides.filter(function(view) {
          return view.model.get('tipo').match(/questao.*/ig);
        });
        soma = respostas.reduce(function(memo, resp) {
          return memo + resp.get('escore');
        }, 0);
        mediaG = soma / respostas.length;
        texto = '';
        this.ui.estResp.find('.mensagem').empty();
        if (respostas.length === questoes.length) {
          this.ui.estResp.find('#btnContinua').hide();
          this.ui.estResp.find('#btnRecomeca').removeClass('btn-xs').addClass('btn-sm');
          texto = `Você já respondeu todas as ${questoes.length} questões deste caso.`;
          this.ui.estResp.find('.mensagem').append($('<p></p>').text(texto));
          texto = `Sua média de acertos final foi de ${mediaG.toFixed(2).replace('.', ',')}%.`;
          this.ui.estResp.find('.mensagem').append($('<p></p>').text(texto));
        } else {
          texto = `Você já respondeu ${respostas.length} das ${questoes.length} questões deste caso.`;
          this.ui.estResp.find('.mensagem').append($('<p></p>').text(texto));
          texto = `Sua média de acertos até agora é de ${mediaG.toFixed(2).replace('.', ',')}%.`;
          this.ui.estResp.find('.mensagem').append($('<p></p>').text(texto));
        }
        this.ui.estResp.removeClass('hide').show();
        return respostas.forEach(function(resposta) {
          var e, i, len, marca, marcadas, opcs, quest, seqid;
          seqid = resposta.get('seqid');
          quest = questoes[seqid];
          opcs = quest.$el.find('.opcoes');
          marcadas = resposta.get('marcadas');
          for (i = 0, len = marcadas.length; i < len; i++) {
            marca = marcadas[i];
            e = opcs.find(`[data-originalidx="${marca}"]:input`);
            // console.log "MARCA RESPOSTA",seqid, marca, e
            e.attr('checked', true);
            e.parent().removeClass('unchecked').addClass('checked');
          }
          quest.silent = true;
          return quest.ui.btnResp.click();
        });
      }

    };

    Caso.prototype.className = 'caso-main container';

    Caso.prototype.template = '#caso-main';

    Caso.prototype.ui = {
      estResp: '.caso #estadoResposta',
      confirmaReset: '.caso #estadoResposta #confirmaRecomeca'
    };

    Caso.prototype.events = {
      'click @ui.estResp #btnRecomeca': 'confirmaRecomeca',
      'click @ui.estResp #btnContinua': 'vaiPraQuestaoDaVez'
    };

    return Caso;

  }).call(this);
  return Caso;
});
